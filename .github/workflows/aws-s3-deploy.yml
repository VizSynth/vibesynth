name: Deploy to AWS S3 (Production & Staging)

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# Allow only one concurrent deployment per environment
concurrency:
  group: aws-deploy-${{ github.event.inputs.environment || 'auto' }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy-s3:
    name: "ğŸŒ Deploy to AWS S3"
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || (github.event_name == 'release' && 'production' || 'staging') }}
    permissions:
      contents: read
      id-token: write # Required for AWS OIDC
    
    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "âš™ï¸ Configure AWS credentials"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.aws_region || 'us-east-1' }}
          role-session-name: vibesynth-deploy-${{ github.run_id }}

      - name: "ğŸ” Verify AWS access"
        run: |
          echo "AWS Account ID: $(aws sts get-caller-identity --query Account --output text)"
          echo "AWS Region: ${{ vars.aws_region || 'us-east-1' }}"
          echo "Environment: ${{ github.event.inputs.environment || (github.event_name == 'release' && 'production' || 'staging') }}"

      - name: "ğŸš€ Deploy to S3 (Staging)"
        if: ${{ github.event.inputs.environment == 'staging' || (github.ref == 'refs/heads/main' && github.event_name == 'push') }}
        env:
          AWS_S3_BUCKET: ${{ vars.aws_s3_bucket_staging }}
          AWS_CLOUDFRONT_DISTRIBUTION_ID: ${{ vars.aws_cloudfront_distribution_id_staging }}
          AWS_REGION: ${{ vars.aws_region || 'us-east-1' }}
        run: |
          echo "ğŸ¯ Deploying to STAGING environment"
          echo "Bucket: $AWS_S3_BUCKET"
          ./deploy-s3.sh

      - name: "ğŸŒ Deploy to S3 (Production - vibesynth.one)"
        if: ${{ github.event.inputs.environment == 'production' || github.event_name == 'release' }}
        env:
          AWS_S3_BUCKET: ${{ vars.aws_s3_bucket_production }}
          AWS_CLOUDFRONT_DISTRIBUTION_ID: ${{ vars.aws_cloudfront_distribution_id_production }}
          AWS_REGION: ${{ vars.aws_region || 'us-east-1' }}
        run: |
          echo "ğŸŒ Deploying to PRODUCTION environment (vibesynth.one)"
          echo "Bucket: $AWS_S3_BUCKET"
          echo "This will serve vibesynth.one via S3 + CloudFront"
          ./deploy-s3.sh

      - name: "ğŸ“Š Deployment summary"
        run: |
          ENV="${{ github.event.inputs.environment || (github.event_name == 'release' && 'production' || 'staging') }}"
          BUCKET_VAR="AWS_S3_BUCKET_$(echo $ENV | tr '[:lower:]' '[:upper:]')"
          
          echo "## ğŸ‰ VibeSynth Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** $ENV" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Access your deployment:" >> $GITHUB_STEP_SUMMARY
          if [ "$ENV" = "production" ]; then
            echo "- **Production URL:** https://vibesynth.one (via CloudFront)" >> $GITHUB_STEP_SUMMARY
            echo "- **Direct S3 URL:** Check your S3 bucket static website URL" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Staging URL:** Check your staging CloudFront distribution" >> $GITHUB_STEP_SUMMARY
            echo "- **Direct S3 URL:** Check your S3 bucket static website URL" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ What was deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All HTML, CSS, and JavaScript files" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Assets and images" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Proper cache headers configured" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CloudFront cache invalidated (if configured)" >> $GITHUB_STEP_SUMMARY

  notify-success:
    name: "ğŸ“¢ Notify Success"
    runs-on: ubuntu-latest
    needs: [deploy-s3]
    if: success()
    
    steps:
      - name: "âœ… Success notification"
        run: |
          ENV="${{ github.event.inputs.environment || (github.event_name == 'release' && 'production' || 'staging') }}"
          echo "::notice::ğŸ‰ VibeSynth successfully deployed to $ENV!"
          echo "::notice::ğŸŒ Your visual synthesizer is now live on AWS S3"
          echo "::notice::ğŸš€ Build: ${{ github.run_number }}"
          echo "::notice::ğŸ“‹ Commit: ${{ github.sha }}"

  notify-failure:
    name: "ğŸ“¢ Notify Failure"
    runs-on: ubuntu-latest
    needs: [deploy-s3]
    if: failure()
    
    steps:
      - name: "âŒ Failure notification"
        run: |
          ENV="${{ github.event.inputs.environment || (github.event_name == 'release' && 'production' || 'staging') }}"
          echo "::error::ğŸš¨ VibeSynth deployment to $ENV FAILED!"
          echo "::error::âŒ Check the deployment logs for details"
          echo "::error::ğŸ” Common issues: AWS credentials, bucket permissions, CloudFront configuration"
          echo "::error::ğŸ“‹ Failed commit: ${{ github.sha }}"
          exit 1