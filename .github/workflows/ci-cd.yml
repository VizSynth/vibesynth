name: CI/CD Pipeline

on:
  push:
    branches: [ main, feat-*, fix-*, docs-*, perf-*, refactor-* ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  test:
    name: "ğŸ§ª Test Every Commit"
    runs-on: ubuntu-latest
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4
      
    - name: "âš™ï¸ Setup Node.js"
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: "ğŸ“¦ Install dependencies"
      run: npm ci || npm install
      
    - name: "ğŸ­ Install Playwright browsers"
      run: npx playwright install --with-deps chromium
      
    - name: "ğŸš€ Start test server"
      run: |
        python3 -m http.server 8080 &
        sleep 3
        
    - name: "ğŸ§ª Run all tests"
      run: npx playwright test --config=playwright.existing.config.js
      
    - name: "ğŸ“Š Upload test results on failure"
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-results-${{ github.sha }}
        path: test-results/
        
    - name: "âŒ Notify test failure"
      if: failure()
      run: |
        echo "::error::ğŸš¨ TESTS FAILED! Blocking all deployments."
        echo "::error::View detailed results in the uploaded artifacts."
        exit 1

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install ESLint
      run: npm install -g eslint
      
    - name: Run ESLint
      run: eslint script.js layout.js --format=github-actions
      continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run security audit
      run: |
        echo "Scanning for security issues..."
        # Check for common security patterns
        grep -r "eval\|innerHTML\|document.write" . --exclude-dir=.git || true
        
    - name: Check dependencies
      run: |
        npm audit --audit-level=moderate || true

  deploy-dev:
    name: "ğŸš€ Deploy to Development"
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: |
      (contains(github.ref, 'refs/heads/feat-') || 
       contains(github.ref, 'refs/heads/fix-') ||
       contains(github.ref, 'refs/heads/docs-') ||
       contains(github.ref, 'refs/heads/perf-') ||
       contains(github.ref, 'refs/heads/refactor-')) && 
      github.event_name == 'push'
    environment: development
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4
      
    - name: "âš™ï¸ Setup Node.js"
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: "ğŸ—ï¸ Run deploy script"
      run: |
        chmod +x deploy-docs.sh
        ./deploy-docs.sh
        
    - name: "ğŸŒ Deploy to GitHub Pages (Dev Branch)"
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        publish_branch: gh-pages-dev
        force_orphan: true
        
    - name: "âœ… Development deployment complete"
      run: |
        echo "ğŸ‰ Successfully deployed to development environment"
        echo "ğŸ”— Dev URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev"

  deploy-staging:
    name: "ğŸ¯ Deploy to Staging"
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: staging
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4
      
    - name: "âš™ï¸ Setup Node.js"
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: "ğŸ—ï¸ Run deploy script"
      run: |
        chmod +x deploy-docs.sh
        ./deploy-docs.sh
        
    - name: "ğŸ¯ Deploy to GitHub Pages (Staging)"
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        publish_branch: gh-pages
        force_orphan: true
        
    - name: "âœ… Staging deployment complete"
      run: |
        echo "ğŸ‰ Successfully deployed to staging environment"
        echo "ğŸ”— Staging URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        
  deploy-production:
    name: "ğŸŒ Deploy to Production"
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: github.event_name == 'release'
    environment: production
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4
      
    - name: "âš™ï¸ Setup Node.js"
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: "ğŸ—ï¸ Run deploy script"
      run: |
        chmod +x deploy-docs.sh
        ./deploy-docs.sh
        
    - name: "ğŸŒ Deploy to Production (vibesynth.one)"
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        cname: vibesynth.one
        force_orphan: true
        
    - name: "ğŸ‰ Production deployment complete"
      run: |
        echo "ğŸš€ Successfully deployed to PRODUCTION!"
        echo "ğŸŒ Live URL: https://vibesynth.one"
        echo "ğŸ“Š Build: ${{ github.run_number }}"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ“‹ Release: ${{ github.event.release.tag_name }}"

  notify:
    name: "ğŸ“¢ Pipeline Status"
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: always()
    
    steps:
    - name: "âœ… Success notification"
      if: ${{ needs.test.result == 'success' && needs.lint.result == 'success' && needs.security.result == 'success' }}
      run: |
        echo "::notice::ğŸ‰ ALL TESTS PASSED! Pipeline successful."
        echo "::notice::âœ… Code quality: GOOD"
        echo "::notice::ğŸ”’ Security: CLEAN"
        echo "::notice::ğŸš€ Ready for deployment"
        
    - name: "âŒ Failure notification"
      if: ${{ needs.test.result == 'failure' || needs.lint.result == 'failure' || needs.security.result == 'failure' }}
      run: |
        echo "::error::ğŸš¨ PIPELINE FAILED - DEPLOYMENTS BLOCKED!"
        echo "::error::âŒ Tests: ${{ needs.test.result }}"
        echo "::error::ğŸ“ Lint: ${{ needs.lint.result }}"
        echo "::error::ğŸ”’ Security: ${{ needs.security.result }}"
        echo "::error::ğŸ” Check the detailed logs and fix issues before deploying."
        exit 1